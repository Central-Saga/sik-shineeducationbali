{
    # Admin API (opsional, bisa di-disable untuk production)
    admin localhost:2019
    
    # Logging
    log {
        output stdout
        format console
        level INFO
    }
}

# HTTP to HTTPS redirect
http://shine.local.test {
    redir https://shine.local.test{uri} permanent
}

# HTTPS dengan mkcert certificate
https://shine.local.test {
    # Menggunakan mkcert certificate untuk trusted SSL
    tls /root/.local/share/mkcert/shine.local.test.pem /root/.local/share/mkcert/shine.local.test-key.pem
    
    # Security headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        Referrer-Policy "strict-origin-when-cross-origin"
    }
    
    # Handle vendor assets PERTAMA (untuk log-viewer frontend assets)
    # PENTING: Handle ini harus sebelum /log-viewer* agar tidak diintercept
    handle /vendor/* {
        reverse_proxy backend:8000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }
    
    # Handle API routes ke Laravel backend (HTTP server)
    handle /api/* {
        reverse_proxy backend:8000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
            # Increase body size limit for file uploads (10MB + buffer)
            transport http {
                dial_timeout 30s
            }
        }
        # Set max body size for file uploads
        request_body {
            max_size 12MB
        }
    }
    
    # Handle static files dari Laravel
    handle /storage/* {
        reverse_proxy backend:8000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }
    
    # Handle Log Viewer routes ke Laravel backend (setelah vendor assets)
    handle /log-viewer* {
        reverse_proxy backend:8000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }
    
    # Handle semua request lainnya ke Next.js frontend
    handle {
        reverse_proxy frontend:3000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }
}
